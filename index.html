<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diagnostic Vocal - Immobilier</title>
    <style>
        /* BASE & RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }
        .header h1 { font-size: 22px; margin-bottom: 8px; }
        .header p { font-size: 13px; opacity: 0.9; }

        /* STATUS BAR */
        .status-bar {
            padding: 10px;
            font-size: 13px;
            text-align: center;
            display: none;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .status-bar.active { display: block; }
        .status-bar.success { background: #d4edda; color: #155724; }
        .status-bar.error { background: #f8d7da; color: #721c24; }

        /* INPUT SECTION */
        .input-section { padding: 20px; }
        .input-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 14px;
        }
        .input-wrapper { display: flex; gap: 8px; }
        textarea {
            flex: 1;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            resize: none;
        }
        textarea:focus { outline: none; border-color: #667eea; }

        .btn-clear {
            width: 45px; background: #fee2e2; border: none;
            color: #ef4444; border-radius: 12px; cursor: pointer;
        }

        /* CONTROLS */
        .voice-controls { display: flex; gap: 10px; margin: 15px 0; }
        .btn {
            border: none; border-radius: 12px; padding: 14px;
            font-weight: 700; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-mic { flex: 1; background: #667eea; color: white; font-size: 16px; }
        .btn-mic.recording { background: #ef4444; animation: pulse 1.5s infinite; }
        .btn-add { width: 100%; background: #10b981; color: white; margin-bottom: 15px; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* PREVIEW */
        .preview-section { padding: 15px 20px; background: #f8fafc; border-top: 1px solid #e2e8f0; }
        .preview-box { font-size: 13px; margin-bottom: 5px; }
        .piece-item {
            display: inline-block; background: #dcfce7; color: #166534;
            padding: 2px 8px; border-radius: 4px; margin: 2px;
        }

        /* TABLE */
        .table-section { padding: 20px; background: white; }
        .table-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .data-table { width: 100%; overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 10px; text-align: left; font-size: 12px; }
        td { padding: 10px; border-top: 1px solid #e2e8f0; font-size: 14px; }
        
        .btn-row { padding: 6px; border-radius: 6px; border: none; cursor: pointer; color: white; }
        .del { background: #ef4444; }
        .edit { background: #667eea; }

        @media (max-width: 480px) {
            body { padding: 0; }
            .container { border-radius: 0; min-height: 100vh; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üè† Diagnostic Immobilier</h1>
        <p>Parsing vocal de localisation et pi√®ces</p>
    </div>

    <div id="statusBar" class="status-bar"></div>

    <div class="input-section">
        <div class="input-group">
            <label>üéôÔ∏è Dict√©e Libre</label>
            <div class="input-wrapper">
                <textarea id="mainInput" placeholder="Ex: B√¢timent A logement 2, deux chambres et un s√©jour..."></textarea>
                <button class="btn-clear" onclick="clearField()">‚úï</button>
            </div>
        </div>

        <div class="voice-controls">
            <button id="micBtn" class="btn btn-mic" onclick="toggleMic()">üé§ Commencer la dict√©e</button>
        </div>

        <button class="btn btn-add" onclick="parseAndAdd()">‚ú® Ajouter au tableau</button>
    </div>

    <div class="preview-section">
        <div class="preview-box"><strong>üìç Localisation :</strong> <span id="preLoc" style="color:#999">En attente...</span></div>
        <div class="preview-box"><strong>üìã Pi√®ces :</strong> <span id="prePie" style="color:#999">En attente...</span></div>
    </div>

    <div class="table-section">
        <div class="table-header">
            <h3>üìä Inventaire</h3>
            <button onclick="exportData()" style="color:#667eea; background:none; border:none; font-weight:bold; cursor:pointer;">üíæ Exporter JSON</button>
        </div>
        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>Localisation</th>
                        <th>Pi√®ce</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr><td colspan="3" style="text-align:center; color:#999; padding:20px;">Aucune donn√©e</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    /* CONFIGURATION & DICTIONNAIRE */
    const PIECES_DICT = {
        'sejour': 'S√©jour', 'salon': 'Salon', 'cuisine': 'Cuisine', 'chambre': 'Chambre',
        'salle de bain': 'Salle de Bain', 'wc': 'WC', 'toilettes': 'WC', 'entree': 'Entr√©e',
        'couloir': 'Couloir', 'cellier': 'Cellier', 'garage': 'Garage', 'balcon': 'Balcon'
    };

    const STOP_WORDS = ['le', 'la', 'les', 'un', 'une', 'des', 'avec', 'et', 'dans', 'nous', 'avons'];

    let recognition = null;
    let isListening = false;
    let dataStore = [];

    /* RECONNAISSANCE VOCALE */
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'fr-FR';

        recognition.onresult = (e) => {
            const transcript = e.results[e.results.length - 1][0].transcript;
            const input = document.getElementById('mainInput');
            input.value += (input.value ? ' ' : '') + transcript;
            updatePreview();
        };

        recognition.onend = () => { if(isListening) recognition.start(); };
    }

    function toggleMic() {
        if (!recognition) return showStatus("Audio non support√©", "error");
        const btn = document.getElementById('micBtn');
        if (!isListening) {
            isListening = true;
            recognition.start();
            btn.classList.add('recording');
            btn.innerHTML = "‚èπÔ∏è Arr√™ter l'√©coute";
            showStatus("√âcoute en cours...", "success");
        } else {
            isListening = false;
            recognition.stop();
            btn.classList.remove('recording');
            btn.innerHTML = "üé§ Commencer la dict√©e";
        }
    }

    /* LOGIQUE DE PARSING */
    function normalize(t) {
        return t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
    }

    function extractLocation(text) {
        const t = normalize(text);
        let loc = [];
        const bat = t.match(/batiment\s+(\w+)/);
        const log = t.match(/logement\s+(\d+)/);
        const rdc = t.includes('rez de chaussee') || t.includes('rdc');
        
        if (bat) loc.push("B√¢t. " + bat[1].toUpperCase());
        if (log) loc.push("Log. " + log[1]);
        if (rdc) loc.push("RDC");
        
        return loc.length ? loc.join(' - ') : null;
    }

    function extractPieces(text) {
        const t = normalize(text);
        const found = [];
        const numMap = {'un':1, 'une':1, 'deux':2, 'trois':3, 'quatre':4, 'cinq':5};
        
        const segments = t.split(/,| et /);
        segments.forEach(s => {
            for (let [key, val] of Object.entries(PIECES_DICT)) {
                if (s.includes(key)) {
                    let qty = 1;
                    const words = s.trim().split(' ');
                    if (numMap[words[0]]) qty = numMap[words[0]];
                    else if (!isNaN(parseInt(words[0]))) qty = parseInt(words[0]);

                    for (let i = 0; i < qty; i++) {
                        found.push(qty > 1 ? `${val} ${i+1}` : val);
                    }
                }
            }
        });
        return found;
    }

    /* UI ACTIONS */
    function updatePreview() {
        const val = document.getElementById('mainInput').value;
        const loc = extractLocation(val);
        const pie = extractPieces(val);

        document.getElementById('preLoc').innerHTML = loc ? `<strong>${loc}</strong>` : "Non d√©tect√©e";
        document.getElementById('prePie').innerHTML = pie.length ? 
            pie.map(p => `<span class="piece-item">${p}</span>`).join('') : "Aucune pi√®ce";
    }

    document.getElementById('mainInput').addEventListener('input', updatePreview);

    function parseAndAdd() {
        const val = document.getElementById('mainInput').value;
        const loc = extractLocation(val) || "Ind√©fini";
        const pieces = extractPieces(val);

        if (!pieces.length) return showStatus("Aucune pi√®ce d√©tect√©e", "error");

        pieces.forEach(p => dataStore.push({ localisation: loc, piece: p }));
        renderTable();
        clearField();
        showStatus(`${pieces.length} pi√®ce(s) ajout√©e(s)`, "success");
    }

    function renderTable() {
        const body = document.getElementById('dataTableBody');
        if (!dataStore.length) {
            body.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999; padding:20px;">Aucune donn√©e</td></tr>';
            return;
        }
        body.innerHTML = dataStore.map((d, i) => `
            <tr>
                <td contenteditable="true" onblur="updateEntry(${i},'localisation',this.innerText)">${d.localisation}</td>
                <td contenteditable="true" onblur="updateEntry(${i},'piece',this.innerText)">${d.piece}</td>
                <td><button class="btn-row del" onclick="deleteRow(${i})">üóëÔ∏è</button></td>
            </tr>
        `).join('');
    }

    function updateEntry(i, key, val) { dataStore[i][key] = val; }

    function deleteRow(i) {
        dataStore.splice(i, 1);
        renderTable();
    }

    function clearField() {
        document.getElementById('mainInput').value = "";
        updatePreview();
    }

    function showStatus(msg, type) {
        const s = document.getElementById('statusBar');
        s.innerText = msg;
        s.className = `status-bar active ${type}`;
        setTimeout(() => s.className = "status-bar", 3000);
    }

    function exportData() {
        if (!dataStore.length) return showStatus("Rien √† exporter", "error");
        const blob = new Blob([JSON.stringify(dataStore, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "export_diagnostic.json";
        a.click();
    }
</script>

</body>
</html>
