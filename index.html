<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Vocal - Immobilier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .input-section {
            padding: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            gap: 8px;
        }

        .input-wrapper textarea {
            flex: 1;
            resize: vertical;
            min-height: 120px;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .input-wrapper textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-clear {
            width: 48px;
            height: 48px;
            border: none;
            background: #ff4757;
            color: white;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .btn-clear:active {
            transform: scale(0.95);
        }

        .voice-controls {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }

        .btn-mic {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-start:active {
            transform: scale(0.98);
        }

        .btn-stop {
            background: #ff4757;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .btn-add {
            width: 100%;
            padding: 16px;
            border: none;
            background: #2ecc71;
            color: white;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
        }

        .btn-add:active {
            transform: scale(0.98);
        }

        .preview-section {
            padding: 16px 20px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
        }

        .preview-section h3 {
            font-size: 16px;
            color: #555;
            margin-bottom: 12px;
        }

        .preview-box {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 14px;
            border: 2px solid #e0e0e0;
        }

        .preview-box.location {
            color: #667eea;
            font-weight: 600;
        }

        .preview-box.pieces {
            color: #2ecc71;
        }

        .preview-box .piece-item {
            display: inline-block;
            background: #e8f5e9;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 13px;
        }

        .table-section {
            padding: 20px;
            background: #f8f9fa;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .table-header h2 {
            font-size: 20px;
            color: #333;
        }

        .btn-export {
            padding: 10px 20px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .data-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .data-table td[contenteditable] {
            cursor: text;
            transition: background 0.2s;
        }

        .data-table td[contenteditable]:hover {
            background: #f8f9fa;
        }

        .data-table td[contenteditable]:focus {
            outline: 2px solid #667eea;
            background: #fff;
        }

        .row-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .btn-action {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-delete {
            background: #ff4757;
            color: white;
        }

        .btn-describe {
            background: #667eea;
            color: white;
        }

        .btn-action:active {
            transform: scale(0.95);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .status-bar {
            padding: 12px 20px;
            background: #fff3cd;
            color: #856404;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .status-bar.active {
            display: block;
        }

        .status-bar.success {
            background: #d4edda;
            color: #155724;
        }

        .status-bar.error {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                min-height: 100vh;
            }

            .header h1 {
                font-size: 20px;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Diagnostic Immobilier</h1>
            <p>Saisie vocale intelligente - Parsing automatique</p>
        </div>

        <div class="status-bar" id="statusBar"></div>

        <div class="input-section">
            <div class="input-group">
                <label>üé§ Dict√©e compl√®te (Localisation + Pi√®ces)</label>
                <div class="input-wrapper">
                    <textarea 
                        id="mainInput" 
                        placeholder="Ex: B√¢timent A logement 2 rez de chauss√©e avec deux chambres, un s√©jour, une cuisine et une salle de bain"
                    ></textarea>
                    <button class="btn-clear" onclick="clearField()">‚úï</button>
                </div>
            </div>

            <div class="voice-controls">
                <button class="btn-mic btn-start" id="micBtn" onclick="toggleMic()">
                    üé§ Commencer la dict√©e
                </button>
            </div>

            <button class="btn-add" onclick="parseAndAdd()">
                ‚ú® Parser et ajouter
            </button>
        </div>

        <div class="preview-section">
            <h3>üìã Aper√ßu du parsing</h3>
            <div class="preview-box location" id="previewLocation">
                Localisation : <span style="color: #999;">en attente...</span>
            </div>
            <div class="preview-box pieces" id="previewPieces">
                Pi√®ces : <span style="color: #999;">en attente...</span>
            </div>
        </div>

        <div class="table-section">
            <div class="table-header">
                <h2>üìä Donn√©es collect√©es</h2>
                <button class="btn-export" onclick="exportData()">üíæ Exporter</button>
            </div>

            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40%">Localisation</th>
                            <th style="width: 40%">Pi√®ce</th>
                            <th style="width: 20%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr class="empty-state">
                            <td colspan="3">Aucune donn√©e pour le moment</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isListening = false;
        let dataStore = [];

        // Dictionnaire des pi√®ces reconnues
        const PIECES_DICT = {
            // Habitat - logements
            'entree': 'Entr√©e',
            'hall': 'Hall d\'entr√©e',
            'hall d\'entree': 'Hall d\'entr√©e',
            'vestibule': 'Vestibule',
            'degagement': 'D√©gagement',
            'couloir': 'Couloir',
            'circulation': 'Circulation',
            'palier': 'Palier int√©rieur',
            'palier interieur': 'Palier int√©rieur',
            'sejour': 'S√©jour',
            'salon': 'Salon',
            'salle de sejour': 'Salle de s√©jour',
            'sejour salon': 'S√©jour salon',
            'piece de vie': 'Pi√®ce de vie',
            'salle a vivre': 'Salle √† vivre',
            'living': 'Living',
            'salle a manger': 'Salle √† manger',
            'coin repas': 'Coin repas',
            'cuisine': 'Cuisine',
            'cuisine ouverte': 'Cuisine ouverte',
            'cuisine americaine': 'Cuisine am√©ricaine',
            'coin cuisine': 'Coin cuisine',
            'kitchenette': 'Kitchenette',
            'arriere cuisine': 'Arri√®re-cuisine',
            'chambre': 'Chambre',
            'chambre parentale': 'Chambre parentale',
            'suite parentale': 'Suite parentale',
            'coin nuit': 'Coin nuit',
            'bureau': 'Bureau',
            'piece bureau': 'Pi√®ce bureau',
            'salle de bain': 'Salle de bain',
            'salle de bains': 'Salle de bain',
            'salle d\'eau': 'Salle d\'eau',
            'salle de douche': 'Salle de douche',
            'sdb': 'Salle de bain',
            'sde': 'Salle d\'eau',
            'wc': 'WC',
            'toilettes': 'Toilettes',
            'sanitaires': 'Sanitaires',
            'cabinet d\'aisance': 'Cabinet d\'aisance',
            'dressing': 'Dressing',
            'placard': 'Placard',
            'placard mural': 'Placard mural',
            'penderie': 'Penderie',
            'buanderie': 'Buanderie',
            'lingerie': 'Lingerie',
            'cellier': 'Cellier',
            'reserve': 'R√©serve',
            'debarras': 'D√©barras',
            'grenier': 'Grenier',
            'combles': 'Combles',
            'combles amenages': 'Combles am√©nag√©s',
            'combles perdus': 'Combles perdus',
            'cave': 'Cave',
            'cave voutee': 'Cave vo√ªt√©e',
            'cave privative': 'Cave privative',
            'garage': 'Garage',
            'box': 'Box',
            'parking': 'Parking',
            'stationnement': 'Stationnement',
            'balcon': 'Balcon',
            'terrasse': 'Terrasse',
            'loggia': 'Loggia',
            'veranda': 'V√©randa',
            // Tertiaire
            'open space': 'Open space',
            'plateau': 'Plateau de bureaux',
            'salle de reunion': 'Salle de r√©union',
            'salle de conference': 'Salle de conf√©rence',
            'salle de formation': 'Salle de formation',
            'accueil': 'Accueil',
            'reception': 'R√©ception',
            'local informatique': 'Local informatique',
            'salle serveur': 'Salle serveur',
            'reprographie': 'Reprographie',
            'cafeteria': 'Caf√©t√©ria',
            'salle de pause': 'Salle de pause',
            'archives': 'Archives',
            'vestiaires': 'Vestiaires',
            'vestiaire': 'Vestiaire',
            // Locaux techniques
            'local technique': 'Local technique',
            'local electrique': 'Local √©lectrique',
            'chaufferie': 'Chaufferie',
            'local chaudiere': 'Local chaudi√®re',
            'local pac': 'Local PAC',
            'local vmc': 'Local VMC',
            'local menage': 'Local m√©nage',
            'local entretien': 'Local entretien',
            'local dechets': 'Local d√©chets',
            'local poubelles': 'Local poubelles',
            'stock': 'Stock',
            'stockage': 'Stockage',
            // ERP
            'salle polyvalente': 'Salle polyvalente',
            'salle des fetes': 'Salle des f√™tes',
            'salle de sport': 'Salle de sport',
            'gymnase': 'Gymnase',
            'douches': 'Douches',
            'cuisine professionnelle': 'Cuisine professionnelle',
            'plonge': 'Plonge',
            'office': 'Office',
            'chambre froide': 'Chambre froide',
            'salle de classe': 'Salle de classe',
            'amphitheatre': 'Amphith√©√¢tre',
            'laboratoire': 'Laboratoire'
        };

        // Mots de localisation
        const LOCATION_KEYWORDS = new Set([
            'batiment', 'immeuble', 'residence', 'site', 'aile',
            'logement', 'appartement', 'lot', 'studio', 'duplex',
            'etage', 'niveau', 'rez de chaussee', 'rdc', 'sous-sol',
            'entree', 'escalier', 'ascenseur'
        ]);

        // Mots parasites √† ignorer
        const STOP_WORDS = new Set([
            'alors', 'donc', 'voila', 'bon', 'ok', 'euh', 'hein', 'hum', 'ben', 'bah',
            'tu', 'vois', 'vous', 'voyez', 'ici', 'la', 'juste', 'plutot', 'environ',
            'a', 'peu', 'pres', 'par', 'on', 'nous', 'avons', 'il', 'y', 'c\'est',
            'ce', 'sont', 'ca', 'correspond', 'est', 'dans', 'passe', 'je', 'dirais',
            'pense', 'peut', 'etre', 'peut-etre', 'normalement', 'en', 'fait',
            'globalement', 'plusieurs', 'quelques', 'avec', 'sans', 'pour', 'ou',
            'le', 'la', 'les', 'un', 'une', 'des', 'de', 'du'
        ]);

        function normalizeText(text) {
            return text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/['']/g, '\'')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Initialisation de la reconnaissance vocale
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                showStatus('‚ö†Ô∏è La reconnaissance vocale n\'est pas support√©e par votre navigateur', 'error');
                return false;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'fr-FR';

            recognition.onresult = (e) => {
                const lastResult = e.results[e.results.length - 1];
                if (lastResult.isFinal) {
                    const transcript = lastResult[0].transcript.trim();
                    insertText(transcript);
                }
            };

            recognition.onerror = (e) => {
                console.error('Erreur reconnaissance vocale:', e.error);
                if (e.error === 'no-speech') {
                    showStatus('Aucune parole d√©tect√©e', 'error');
                } else {
                    showStatus('Erreur: ' + e.error, 'error');
                }
            };

            recognition.onend = () => {
                if (isListening) {
                    recognition.start();
                }
            };

            return true;
        }

        function toggleMic() {
            if (!recognition && !initSpeechRecognition()) return;

            const btn = document.getElementById('micBtn');
            
            if (isListening) {
                isListening = false;
                recognition.stop();
                btn.className = 'btn-mic btn-start';
                btn.innerHTML = 'üé§ Commencer la dict√©e';
                showStatus('Micro arr√™t√©', 'success');
            } else {
                isListening = true;
                recognition.start();
                btn.className = 'btn-mic btn-stop';
                btn.innerHTML = '‚èπÔ∏è Arr√™ter la dict√©e';
                showStatus('üéôÔ∏è √âcoute en cours... Parlez maintenant', 'success');
            }
        }

        function insertText(text) {
            const input = document.getElementById('mainInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const currentValue = input.value;
            
            const newValue = currentValue.substring(0, start) + 
                            (currentValue.substring(0, start).length > 0 ? ' ' : '') +
                            text + 
                            currentValue.substring(end);
            
            input.value = newValue;
            input.focus();
            
            // Mise √† jour preview en temps r√©el
            updatePreview();
        }

        function clearField() {
            document.getElementById('mainInput').value = '';
            updatePreview();
        }

        function extractLocation(text) {
            const normalized = normalizeText(text);
            const words = normalized.split(' ');
            
            let locationParts = [];
            let i = 0;
            
            while (i < words.length) {
                const word = words[i];
                
                // D√©tection b√¢timent
                if (word === 'batiment' && i + 1 < words.length) {
                    locationParts.push('B√¢timent ' + words[i + 1].toUpperCase());
                    i += 2;
                    continue;
                }
                
                // D√©tection logement/appartement
                if ((word === 'logement' || word === 'appartement') && i + 1 < words.length) {
                    locationParts.push('Logement ' + words[i + 1]);
                    i += 2;
                    continue;
                }
                
                // D√©tection √©tage
                if (word === 'rez' || word === 'rdc') {
                    locationParts.push('RDC');
                    i += 3; // skip "de chauss√©e"
                    continue;
                }
                
                if (word === 'etage') {
                    if (i > 0) {
                        const prev = words[i - 1];
                        if (prev === 'premier' || prev === '1er') {
                            locationParts.push('1er √©tage');
                        } else if (prev === 'deuxieme' || prev === '2eme' || prev === '2e') {
                            locationParts.push('2√®me √©tage');
                        } else if (prev === 'troisieme' || prev === '3eme' || prev === '3e') {
                            locationParts.push('3√®me √©tage');
                        }
                    }
                    i++;
                    continue;
                }
                
                i++;
            }
            
            return locationParts.length > 0 ? locationParts.join(' - ') : null;
        }

        function extractPieces(text) {
            const normalized = normalizeText(text);
            
            const numberMap = {
                'un': 1, 'une': 1, 'deux': 2, 'trois': 3, 'quatre': 4, 
                'cinq': 5, 'six': 6, 'sept': 7, 'huit': 8, 'neuf': 9, 'dix': 10
            };

            // S√©paration par virgules et "et"
            const segments = normalized
                .replace(/\s*,\s*/g, '|')
                .replace(/\s+et\s+/g, '|')
                .split('|')
                .map(s => s.trim())
                .filter(s => s);

            const pieces = [];

            segments.forEach(segment => {
                // Nettoyage des mots parasites
                let words = segment.split(/\s+/).filter(w => !STOP_WORDS.has(w));
                
                if (words.length === 0) return;

                let quantity = 1;

                // D√©tection quantit√©
                const firstWord = words[0];
                if (numberMap[firstWord]) {
                    quantity = numberMap[firstWord];
                    words = words.slice(1);
                } else if (!isNaN(parseInt(firstWord))) {
                    quantity = parseInt(firstWord);
                    words = words.slice(1);
                }

                if (words.length === 0) return;

                // Recherche de correspondance dans le dictionnaire
                let matchedPiece = null;
                
                for (let len = words.length; len > 0; len--) {
                    const testKey = words.slice(0, len).join(' ');
                    
                    if (PIECES_DICT[testKey]) {
                        matchedPiece = PIECES_DICT[testKey];
                        break;
                    }
                    
                    for (const [key, value] of Object.entries(PIECES_DICT)) {
                        if (key.startsWith(testKey) || testKey.startsWith(key)) {
                            matchedPiece = value;
                            break;
                        }
                    }
                    
                    if (matchedPiece) break;
                }

                // Si pas de correspondance, on ignore (c'est probablement du contexte de localisation)
                if (!matchedPiece) return;

                // Ajout avec quantit√©
                if (quantity > 1) {
                    for (let i = 1; i <= quantity; i++) {
                        pieces.push(`${matchedPiece} ${i}`);
                    }
                } else {
                    pieces.push(matchedPiece);
                }
            });

            return pieces;
        }

        function updatePreview() {
            const text = document.getElementById('mainInput').value;
            
            if (!text.trim()) {
                document.getElementById('previewLocation').innerHTML = 
                    'Localisation : <span style="color: #999;">en attente...</span>';
                document.getElementById('previewPieces').innerHTML = 
                    'Pi√®ces : <span style="color: #999;">en attente...</span>';
                return;
            }

            const location = extractLocation(text);
            const pieces = extractPieces(text);

            document.getElementById('previewLocation').innerHTML = 
                `Localisation : <strong>${location || '<span style="color: #ff4757;">Non d√©tect√©e</span>'}</strong>`;
            
            if (pieces.length > 0) {
                const piecesHtml = pieces.map(p => `<span class="piece-item">${p}</span>`).join(' ');
                document.getElementById('previewPieces').innerHTML = `Pi√®ces (${pieces.length}) : ${piecesHtml}`;
            } else {
                document.getElementById('previewPieces').innerHTML = 
                    'Pi√®ces : <span style="color: #ff4757;">Aucune d√©tect√©e</span>';
            }
        }

        // Mise √† jour preview en temps r√©el
        document.getElementById('mainInput').addEventListener('input', updatePreview);

        function parseAndAdd() {
            const text = document.getElementById('mainInput').value;

            if (!text.trim()) {
                showStatus('‚ö†Ô∏è Veuillez saisir du texte', 'error');
                return;
            }

            const location = extractLocation(text);
            const pieces = extractPieces(text);

            if (!location) {
                showStatus('‚ö†Ô∏è Localisation non d√©tect√©e', 'error');
                return;
            }

            if (pieces.length === 0) {
                showStatus('‚ö†Ô∏è Aucune pi√®ce d√©tect√©e', 'error');
                return;
            }

            pieces.forEach(piece => {
                dataStore.push({ localisation: location, piece });
            });

            renderTable();
            clearField();
            showStatus(`‚úÖ ${pieces.length} pi√®ce(s) ajout√©e(s) avec succ√®s`, 'success');
        }

        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            
            if (dataStore.length === 0) {
                tbody.innerHTML = '<tr class="empty-state"><td colspan="3">Aucune donn√©e pour le moment</td></tr>';
                return;
            }

            tbody.innerHTML = dataStore.map((row, idx) => `
                <tr>
                    <td contenteditable="true" onblur="updateData(${idx}, 'localisation', this.textContent)">${row.localisation}</td>
                    <td contenteditable="true" onblur="updateData(${idx}, 'piece', this.textContent)">${row.piece}</td>
                    <td>
                        <div class="row-actions">
                            <button class="btn-action btn-delete" onclick="deleteRow(${idx})">üóëÔ∏è</button>
                            <button class="btn-action btn-describe" onclick="describeRow(${idx})">üéôÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateData(idx, field, value) {
            if (dataStore[idx]) {
                dataStore[idx][field] = value.trim();
            }
        }

        function deleteRow(idx) {
            if (confirm('Supprimer cette ligne ?')) {
                dataStore.splice(idx, 1);
                renderTable();
                showStatus('‚úÖ Ligne supprim√©e', 'success');
            }
        }

        function describeRow(idx) {
            showStatus('üéôÔ∏è Fonction description (√† venir)', 'success');
        }

        function exportData() {
            if (dataStore.length === 0) {
                showStatus('‚ö†Ô∏è Auc
